name: ğŸ¦– EM-Zilla CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

env:
  NODE_VERSION: '18.x'
  NPM_VERSION: '9.x'

jobs:
  # ğŸ” Security & Quality Checks
  security-audit:
    name: ğŸ”’ Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: |
          npm ci
          npm audit --audit-level=moderate

      - name: ğŸ” Snyk Security Scan
        uses: snyk/actions/node@v2
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

      - name: ğŸš¨ CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          languages: javascript

  # ğŸ§ª Testing Suite
  test-suite:
    name: ğŸ§ª Test Suite
    runs-on: ubuntu-latest
    needs: security-audit
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” ESLint Code Quality
        run: |
          npm run lint
          npm run lint:security

      - name: ğŸ§ª Run Unit Tests
        run: npm run test

      - name: ğŸ›¡ï¸ Security Integrity Tests
        run: npm run test:security

      - name: ğŸ”— Integration Tests
        run: npm run test:integration

      - name: ğŸ“Š Test Coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info

  # ğŸ—ï¸ Build & Package
  build-production:
    name: ğŸ—ï¸ Production Build
    runs-on: ubuntu-latest
    needs: test-suite
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Generate Integrity Hashes
        run: npm run build:hashes

      - name: ğŸ—ï¸ Build Production Bundle
        run: npm run build:obfuscate

      - name: ğŸ” Sign Official Build
        run: npm run build:sign
        env:
          EM_ZILLA_RELEASE_KEY: ${{ secrets.EM_ZILLA_RELEASE_KEY }}

      - name: âœ… Verify Build Integrity
        run: npm run integrity:check

      - name: ğŸ“¦ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: em-zilla-production-build
          path: |
            dist/
            build-reports/
          retention-days: 30

  # ğŸš€ Deploy to GitHub Pages
  deploy-pages:
    name: ğŸŒ Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: build-production
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: em-zilla-production-build
          path: dist

      - name: ğŸ—ï¸ Setup Pages
        uses: actions/configure-pages@v4

      - name: ğŸ“¤ Upload to Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: ğŸ“¢ Notify Deployment
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸ‰ EM-Zilla v${{ github.ref_name }} successfully deployed to GitHub Pages! \n\nğŸŒ **Live Demo**: https://${{ context.repo.owner }}.github.io/${{ context.repo.name }}\nğŸ“¦ **Build Version**: ${{ github.sha }}\nğŸ•’ **Deployed**: ${{ new Date().toISOString() }}'
            })

  # ğŸ·ï¸ Create GitHub Release
  create-release:
    name: ğŸ·ï¸ Create Release
    runs-on: ubuntu-latest
    needs: [build-production, deploy-pages]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: em-zilla-production-build
          path: release-package

      - name: ğŸ·ï¸ Create Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.ref_name }}
          release_name: EM-Zilla v${{ github.ref_name }}
          body: |
            ğŸ¦– **EM-Zilla v${{ github.ref_name }}** - AI-Powered Arduino IDE

            ## ğŸš€ New Features
            - AI-powered code generation
            - PSP Vita-style interface
            - USB hardware detection
            - Enterprise security features

            ## ğŸ“¦ Installation
            ```bash
            # Download from GitHub Releases
            # Or use the live demo:
            # https://${{ github.repository_owner }}.github.io/EM-Zilla
            ```

            ## ğŸ”§ Changes
            ${{ github.event.head_commit.message }}

            ## ğŸ“‹ Checks
            âœ… Security Audit Passed  
            âœ… All Tests Passed  
            âœ… Build Integrity Verified  
            âœ… Deployed to GitHub Pages

          files: |
            release-package/dist/*
            release-package/build-reports/*
          draft: false
          prerelease: false

  # ğŸ“± PWA Validation
  pwa-validation:
    name: ğŸ“± PWA Validation
    runs-on: ubuntu-latest
    needs: deploy-pages
    if: always()

    steps:
      - name: ğŸ” Validate PWA
        uses: GoogleChromeLabs/pwa-helpers/validate-pwa@v1
        with:
          url: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}

      - name: ğŸ“Š Lighthouse CI
        uses: treosh/lighthouse-ci-action@v12
        with:
          uploadArtifacts: true
          temporaryPublicStorage: true
          configPath: './lighthouse.config.js'

  # ğŸ¯ Dependency Updates
  dependency-updates:
    name: ğŸ“¦ Dependency Updates
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ”„ Check for updates
        run: |
          npx npm-check-updates
          npx npm-audit-resolver

      - name: ğŸ“‹ Create Update Issue
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');
            const updates = execSync('npx npm-check-updates --json').toString();
            const updateCount = Object.keys(JSON.parse(updates)).length;
            
            if (updateCount > 0) {
              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸ“¦ Dependency Updates Available (${updateCount} packages)`,
                body: `The following dependencies have updates available:\n\n\`\`\`json\n${updates}\n\`\`\``,
                labels: ['dependencies', 'automated']
              });
            }
